[EN](https://github.com/avtomatika-ai/avtomatika/blob/main/docs/api_reference.md) | [ES](https://github.com/avtomatika-ai/avtomatika/blob/main/docs/es/api_reference.md) | **RU**

# Справочник по API Оркестратора

Этот документ описывает все HTTP-эндпоинты, предоставляемые сервером Оркестратора. API разделен на три логические группы: Публичные, Клиентские и Внутренние (для Воркеров).

## Аутентификация

-   **Клиент -> Оркестратор:** Все запросы к эндпоинтам `/api/*` должны содержать заголовок `X-Client-Token` с токеном клиента.
-   **Воркер -> Оркестратор:** Все запросы к эндпоинтам `/_worker/*` должны содержать заголовок `X-Worker-Token` с валидным токеном воркера (индивидуальным или общим).

---

## 1. Публичные эндпоинты (`/_public`)

Эти эндпоинты не требуют аутентификации.

### Проверка статуса сервиса

-   **Эндпоинт:** `GET /_public/status`
-   **Описание:** Возвращает простой ответ, подтверждающий, что сервис работает.
-   **Ответ (`200 OK`):** `{"status": "ok"}`

### Метрики Prometheus

-   **Эндпоинт:** `GET /_public/metrics`
-   **Описание:** Возвращает метрики приложения в формате, совместимом с Prometheus.
-   **Ответ (`200 OK`):** Текстовый ответ с метриками.

### Вебхук для "Human Approval"

-   **Эндпоинт:** `POST /_public/webhooks/approval/{job_id}`
-   **Описание:** Позволяет внешней системе утвердить или отклонить шаг в пайплайне.
-   **Тело запроса:** `{"decision": "approved"}`
-   **Ответ (`200 OK`):** `{"status": "approval_received", "job_id": "..."}`

### Отладочный эндпоинт для очистки БД

-   **Эндпоинт:** `POST /_public/debug/flush_db`
-   **Описание:** **(Только для разработки!)** Очищает всю базу данных Redis.
-   **Ответ (`200 OK`):** `{"status": "db_flushed"}`

---

## 2. Клиентские эндпоинты (`/api`)

Эти эндпоинты предназначены для внешних систем, которые инициируют и отслеживают рабочие процессы. Требуют заголовок `X-Client-Token`.

### Создание нового задания

-   **Эндпоинт:** `POST /api/{api_version}/{blueprint_api_endpoint}`
-   **Пример:** `POST /api/v1/jobs/simple_flow`
-   **Описание:** Создает и запускает новый экземпляр (Job) указанного блупринта.
-   **Тело запроса:**
    ```json
    {
      "initial_data": { ... },
      "webhook_url": "https://callback.url/webhook",
      "dispatch_timeout": 60,
      "result_timeout": 300
    }
    ```
    *   `initial_data` (объект, необязательно): Исходные данные для задания.
    *   `webhook_url` (строка, необязательно): URL для получения асинхронных уведомлений о завершении, сбое или карантине задания.
    *   `dispatch_timeout` (integer, необязательно): Время в секундах, которое задача может ожидать воркера в очереди. Если не взят за это время — отмена.
    *   `result_timeout` (integer, необязательно): Абсолютный дедлайн (в секундах) для получения результата с момента создания.
-   **Ответ (`202 Accepted`):** `{"status": "accepted", "job_id": "..."}`
-   **Ответ (`429 Too Many Requests`):** Если превышен лимит запросов для клиента или IP-адреса.

### Получение статуса задания

-   **Эндпоинт:** `GET /api/v1/jobs/{job_id}`
-   **Описание:** Возвращает полное текущее состояние указанного задания.
-   **Ответ (`200 OK`):** JSON-объект с состоянием `Job`.
-   **Ответ (`404 Not Found`):** Если задание с таким ID не найдено.

### Получение ссылки для загрузки в S3

-   **Эндпоинт:** `GET /api/v1/jobs/{job_id}/files/upload`
-   **Описание:** Генерирует временную ссылку (presigned URL) для загрузки файла напрямую в хранилище S3 задания.
-   **Параметры запроса (Query Parameters):**
    *   `filename` (string, обязательно): Имя файла для загрузки.
    *   `expires_in` (integer, необязательно): Срок действия ссылки в секундах. По умолчанию: `3600`.
-   **Ответ (`200 OK`):** `{"url": "...", "expires_in": 3600, "method": "PUT"}`
-   **Ответ (`501 Not Implemented`):** Если поддержка S3 не включена.

### Загрузка файла (Прямой стриминг)

-   **Эндпоинт:** `PUT /api/v1/jobs/{job_id}/files/content/{filename}`
-   **Описание:** Загружает файл напрямую в S3 через стриминг-прокси Оркестратора. Файл не сохраняется на диск Оркестратора и потребляет минимум RAM.
-   **Тело запроса:** Бинарное содержимое файла.
-   **Ответ (`200 OK`):** `{"status": "uploaded", "s3_uri": "..."}`

### Скачивание файла (Постоянная ссылка)

-   **Эндпоинт:** `GET /api/v1/jobs/{job_id}/files/download/{filename}`
-   **Описание:** Постоянная ссылка, которая автоматически перенаправляет на свежий Presigned URL в S3. Удобно для загрузки файлов в браузере.
-   **Ответ (`302 Found`):** Редирект на URL в S3.

### Отмена выполняемой задачи

- **Эндпоинт**: `POST /api/v1/jobs/{job_id}/cancel`
- **Описание**: Инициирует отмену задачи, выполняемой воркером.
- **Ответ (`200 OK`):** `{"status": "cancellation_request_sent"}` (если через WebSocket) или `{"status": "cancellation_request_accepted"}` (если через флаг в Redis).

### Получение истории задания

-   **Эндпоинт:** `GET /api/v1/jobs/{job_id}/history`
-   **Описание:** Возвращает полную историю событий для указанного задания (если включено хранилище истории).
-   **Ответ (`200 OK`):** Массив объектов с событиями.

### Получение графа блупринта

-   **Эндпоинт:** `GET /api/v1/blueprints/{blueprint_name}/graph`
-   **Описание:** Возвращает структуру блупринта в формате DOT для визуализации.
-   **Ответ (`200 OK`):** Текстовый ответ в формате `text/vnd.graphviz`.

### Получение списка активных воркеров

-   **Эндпоинт:** `GET /api/v1/workers`
-   **Описание:** Возвращает список всех активных в данный момент воркеров.
-   **Ответ (`200 OK`):** Массив объектов с информацией о воркерах.

### Получение сводной информации (Dashboard)

-   **Эндпоинт:** `GET /api/v1/dashboard`
-   **Описание:** Возвращает агрегированную статистику о состоянии системы.
-   **Ответ (`200 OK`):** JSON-объект со статистикой.

---

## 3. Внутренние эндпоинты для Воркеров (`/_worker`)

Эти эндпоинты используются воркерами для регистрации, получения задач и отправки результатов. Требуют заголовок `X-Worker-Token`.

### Регистрация Воркера

-   **Эндпоинт:** `POST /_worker/workers/register`
-   **Описание:** Регистрирует воркер в системе.
-   **Тело запроса:** JSON-объект с полным описанием воркера (ID, поддерживаемые задачи, ресурсы и т.д.).
    ```json
    {
      "worker_id": "worker-123",
      "supported_skills": ["video_processing", "audio_transcription"]
    }
    ```
-   **Ответ (`200 OK`):** `{"status": "registered"}`

### Heartbeat / Обновление статуса

-   **Эндпоинт:** `PATCH /_worker/workers/{worker_id}`
-   **Описание:** Универсальный эндпоинт для подтверждения активности и обновления состояния.
    -   **С пустым телом:** Работает как легковесный "ping", только обновляет TTL воркера.
    -   **С телом запроса (JSON):** Обновляет данные воркера (статус, нагрузку, доступные задачи) и обновляет TTL.
-   **Ответ (`200 OK`):** `{"status": "ttl_refreshed"}` или JSON с обновленным состоянием воркера.

### Получение следующей задачи (Long-Polling)

-   **Эндпоинт:** `GET /_worker/workers/{worker_id}/tasks/next`
-   **Описание:** Воркер запрашивает следующую задачу. Соединение удерживается, если задач нет.
-   **Ответ (`200 OK`):** JSON-объект с данными задачи.
-   **Ответ (`204 No Content`):** Возвращается по таймауту, если новых задач не появилось.

### Отправка результата задачи

-   **Эндпоинт:** `POST /_worker/tasks/result`
-   **Описание:** Воркер отправляет результат выполненной задачи.
-   **Тело запроса:**
    ```json
    {
      "job_id": "...",
      "task_id": "...",
      "worker_id": "...",
      "status": "success",
      "data": { "output": "..." },
      "error": null
    }
    ```
-   **Ответ (`200 OK`):** `{"status": "result_accepted_success"}`

### Установка WebSocket соединения

- **Эндпоинт**: `GET /_worker/ws/{worker_id}`
- **Описание**: Устанавливает WebSocket соединение для получения команд от оркестратора в реальном времени (например, `cancel_task`).
- **Протокол**: `WebSocket`
