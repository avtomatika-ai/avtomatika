[EN](https://github.com/avtomatika-ai/avtomatika/blob/main/docs/configuration.md) | [ES](https://github.com/avtomatika-ai/avtomatika/blob/main/docs/es/configuration.md) | **RU**

# Справочник по конфигурационным файлам

Для управления доступом и настройками клиентов и воркеров Avtomatika использует файлы в формате [TOML](https://toml.io/en/).

Система реализует принцип **Fail Fast**: если при запуске обнаружится ошибка в синтаксисе TOML или отсутствие обязательных полей, Оркестратор **не запустится** и выбросит исключение. Это гарантирует, что система не будет работать в некорректном или небезопасном состоянии.

---

## 1. clients.toml

Этот файл определяет список API-клиентов, которые имеют право создавать задания.

**Путь по умолчанию:** Можно задать через переменную окружения `CLIENTS_CONFIG_PATH`. Обычно располагается в корне проекта.

### Структура

Файл состоит из секций (таблиц), где название секции — это уникальный идентификатор клиента (для логов и удобства).

| Поле | Тип | Обязательно | Описание |
| :--- | :--- | :--- | :--- |
| `token` | String | **Да** | Секретный токен, который клиент должен передавать в заголовке `X-Client-Token`. |
| `plan` | String | Нет | Название тарифного плана (например, "free", "premium"). Используется в блупринтах для логики. |
| `monthly_attempts` | Integer | Нет | Месячная квота запросов. Если задана, Оркестратор будет вести учет и блокировать запросы сверх лимита. |
| `*` | Any | Нет | Любые другие поля (например, `languages`, `callback_url`) будут доступны в `context.client.params`. |

### Пример

```toml
# Клиент с премиум-доступом
[client_premium_user]
token = "sec_vip_token_123"
plan = "premium"
monthly_attempts = 100000
# Кастомные параметры
languages = ["en", "de", "fr"]
priority_support = true

# Клиент с бесплатным доступом
[client_free_user]
token = "sec_free_token_456"
plan = "free"
monthly_attempts = 100
languages = ["en"]
```

---

## 2. workers.toml

Этот файл используется для настройки индивидуальной аутентификации воркеров. Это более безопасная альтернатива использованию единого глобального токена.

**Путь по умолчанию:** Можно задать через переменную окружения `WORKERS_CONFIG_PATH`.

### Структура

Файл состоит из секций, где название секции должно **в точности совпадать** с `worker_id`, который воркер использует при регистрации.

| Поле | Тип | Обязательно | Описание |
| :--- | :--- | :--- | :--- |
| `token` | String | **Да** | Индивидуальный секретный токен для этого воркера. |
| `description` | String | Нет | Описание воркера для администраторов. |

### Особенности безопасности
*   При загрузке Оркестратор вычисляет SHA-256 хеш от токена и хранит в памяти (Redis) только его. Исходный токен нигде не сохраняется.
*   При входящем запросе от воркера хеш предоставленного токена сравнивается с сохраненным.

### Пример

```toml
# Секция должна называться так же, как WORKER_ID на стороне воркера
[gpu-worker-01]
token = "super-secret-token-for-gpu-01"
description = "Primary GPU node for video rendering"

[cpu-worker-01]
token = "another-secret-token-for-cpu-01"
description = "General purpose CPU worker"
```

---

## 3. schedules.toml

Этот файл настраивает Нативный Планировщик (Native Scheduler), позволяя запускать блупринты периодически без использования внешних cron-задач.

**Путь по умолчанию:** Можно задать через переменную окружения `SCHEDULES_CONFIG_PATH`.

### Структура

Каждая секция представляет собой запланированную задачу. Имя секции служит уникальным идентификатором задачи.

| Поле | Тип | Обязательно | Описание |
| :--- | :--- | :--- | :--- |
| `blueprint` | String | **Да** | Имя блупринта для выполнения. |
| `input_data` | Dictionary | Нет | Входные данные для задачи. По умолчанию пустой словарь. |
| `interval_seconds` | Integer | *Одно из* | Запуск каждые N секунд. |
| `daily_at` | String | *Одно из* | Ежедневный запуск в указанное время ("HH:MM"). |
| `weekly_days` | List[String] | *Одно из* | Запуск в определенные дни ("mon", "tue"...) в `time`. |
| `monthly_dates` | List[Integer] | *Одно из* | Запуск в определенные числа месяца (1-31) в `time`. |
| `time` | String | *Одно из* | Обязательно для `weekly_days` и `monthly_dates`. Формат "HH:MM". |

**Примечание о часовых поясах:** Все поля времени интерпретируются в соответствии с глобальной переменной окружения `TZ` (по умолчанию "UTC").

### Пример

```toml
[cleanup_job]
blueprint = "system_cleanup"
interval_seconds = 3600
input_data = { target = "temp_files" }

[daily_report]
blueprint = "generate_report"
daily_at = "09:00" # Запуск в 09:00 по времени TZ
input_data = { type = "full_daily" }

[weekly_backup]
blueprint = "full_backup"
weekly_days = ["fri"]
time = "23:00"
input_data = { compression = "max" }
```

---

## Динамическая перезагрузка

Вы можете обновлять `workers.toml` без перезапуска Оркестратора.
Для этого отправьте POST-запрос (с валидным клиентским токеном) на эндпоинт:

`POST /api/v1/admin/reload-workers`

Это заставит Оркестратор заново прочитать файл и обновить хеши токенов в Redis.

---

## Переменные окружения

Помимо файлов конфигурации, Оркестратор настраивается через переменные окружения.

| Переменная | Описание | По умолчанию |
| :--- | :--- | :--- |
| `API_HOST` | Хост для запуска API сервера. | `0.0.0.0` |
| `API_PORT` | Порт для запуска API сервера. | `8080` |
| `ENABLE_CLIENT_API` | **Режим Чистого Холона:** Если `false`, отключает клиентский API (`/api/v1/...`). Оркестратор будет принимать задачи только от родителя через RXON (интерфейс воркера). | `true` |
| `REDIS_HOST` | Хост сервера Redis. Обязательно для продакшена. | `""` (MemoryStorage) |
| `REDIS_PORT` | Порт сервера Redis. | `6379` |
| `REDIS_DB` | Индекс базы данных Redis. | `0` |
| `INSTANCE_ID` | **Важно для масштабирования:** Уникальный идентификатор экземпляра Оркестратора. Используется как имя потребителя (consumer name) в Redis Streams. Если не задано, используется имя хоста. | `hostname` |
| `CLIENT_TOKEN` | Глобальный токен для API клиентов (фоллбэк, если `clients.toml` не используется). | `secure-orchestrator-token` |
| `GLOBAL_WORKER_TOKEN` | Глобальный токен для воркеров (фоллбэк, если `workers.toml` не используется). | `secure-worker-token` |
| `WORKERS_CONFIG_PATH` | Путь к файлу `workers.toml`. | `""` |
| `CLIENTS_CONFIG_PATH` | Путь к файлу `clients.toml`. | `""` |
| `SCHEDULES_CONFIG_PATH` | Путь к файлу `schedules.toml`. | `""` |
| `TZ` | **Глобальный часовой пояс:** Влияет на триггеры планировщика, время в логах и вывод истории в API (например, "Europe/Moscow", "UTC"). | `UTC` |
| `EXECUTOR_MAX_CONCURRENT_JOBS` | Максимальное количество одновременно выполняемых задач (обработчиков) внутри Оркестратора. | `100` |
| `HISTORY_DATABASE_URI` | URI для хранения истории (`sqlite:///...` или `postgresql://...`). | `""` (Отключено) |
| `LOG_LEVEL` | Уровень логирования (`DEBUG`, `INFO`, `WARNING`, `ERROR`). | `INFO` |
| `LOG_FORMAT` | Формат логов (`text` или `json`). | `json` |
| `WORKER_TIMEOUT_SECONDS` | Таймаут выполнения задачи воркером. | `300` |
| `WORKER_POLL_TIMEOUT_SECONDS` | Таймаут ожидания новой задачи воркером (Long Polling). | `30` |
| `WORKER_HEALTH_CHECK_INTERVAL_SECONDS` | Интервал обновления TTL воркера (используется для Health Check). | `60` |
| `JOB_MAX_RETRIES` | Максимальное количество попыток повторного выполнения задачи. | `3` |
| `WATCHER_INTERVAL_SECONDS` | Интервал проверки "зависших" задач процессом Watcher. | `20` |
| `RATE_LIMITING_ENABLED` | Включить ограничение частоты запросов (Rate Limiting). | `true` |
| `RATE_LIMIT_LIMIT` | Лимит по умолчанию для общих API запросов (за период). | `100` |
| `RATE_LIMIT_PERIOD` | Период ограничения в секундах. | `60` |
| `RATE_LIMIT_HEARTBEAT_LIMIT` | Специальный лимит для heartbeat-запросов воркеров. | `120` |
| `RATE_LIMIT_POLL_LIMIT` | Специальный лимит для запросов на получение задач (poll). | `60` |

### Безопасность и TLS (mTLS)

Настройки для включения HTTPS и взаимной аутентификации (Zero Trust).

| Переменная | Описание | По умолчанию |
| :--- | :--- | :--- |
| `TLS_ENABLED` | Включить HTTPS сервер. | `false` |
| `TLS_CERT_PATH` | Путь к SSL сертификату сервера (`.crt`). Обязательно, если TLS включен. | `""` |
| `TLS_KEY_PATH` | Путь к приватному ключу сервера (`.key`). Обязательно, если TLS включен. | `""` |
| `TLS_CA_PATH` | Путь к CA сертификату для проверки сертификатов клиентов. | `""` |
| `TLS_REQUIRE_CLIENT_CERT` | Если `true`, сервер будет требовать валидный сертификат от клиента (mTLS). | `false` |

### S3 Хранилище (Опционально)

Настройте эти переменные для включения поддержки S3 Payload Offloading в Оркестраторе.

| Переменная | Описание | По умолчанию |
| :--- | :--- | :--- |
| `S3_ENDPOINT_URL` | URL S3-совместимого хранилища. **Обязательно** для включения S3. | `""` |
| `S3_ACCESS_KEY` | Ключ доступа (Access Key). **Обязательно**. | `""` |
| `S3_SECRET_KEY` | Секретный ключ (Secret Key). **Обязательно**. | `""` |
| `S3_DEFAULT_BUCKET` | Имя бакета по умолчанию для хранения файлов задач. | `avtomatika-payloads` |
| `S3_REGION` | Регион S3. | `us-east-1` |
| `S3_MAX_CONCURRENCY` | Максимальное количество одновременных подключений к S3 для всех задач. Предотвращает исчерпание дескрипторов. | `100` |
| `TASK_FILES_DIR` | Локальная директория для временного хранения файлов во время выполнения задачи. | `/tmp/avtomatika-payloads` |
