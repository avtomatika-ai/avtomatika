[EN](https://github.com/avtomatika-ai/avtomatika/blob/main/docs/cookbook/advanced_topics.md) | [ES](https://github.com/avtomatika-ai/avtomatika/blob/main/docs/es/cookbook/advanced_topics.md) | **RU**

# Cookbook: Продвинутые возможности

Этот раздел описывает более сложные, но мощные возможности системы, которые могут быть полезны в реальных сценариях.

## 1. Подключение Воркера к нескольким Оркестраторам

Для обеспечения высокой доступности и распределения нагрузки SDK воркера может подключаться к нескольким экземплярам Оркестратора.

-   **Переменная окружения:** `ORCHESTRATORS_CONFIG` (заменяет `ORCHESTRATOR_URL`). Содержит JSON-строку со списком адресов.
-   **Режим работы:** `MULTI_ORCHESTRATOR_MODE`.

### Режим `FAILOVER` (Отказоустойчивость)

Это режим по умолчанию. Воркер будет работать с первым Оркестратором в списке. Если тот станет недоступен, воркер автоматически переключится на следующий.

**Пример конфигурации:**
```dotenv
# Воркер будет опрашивать 'main-orchestrator'. Если он упадет,
# SDK автоматически переключится на 'backup-orchestrator'.
ORCHESTRATORS_CONFIG='[
    {"url": "http://main-orchestrator:8080"},
    {"url": "http://backup-orchestrator:8080"}
]'

MULTI_ORCHESTRATOR_MODE=FAILOVER
```

### Режим `ROUND_ROBIN` (Балансировка нагрузки)

В этом режиме воркер будет поочередно отправлять запросы на получение задач к каждому Оркестратору из списка, распределяя нагрузку.

**Пример конфигурации:**
```dotenv
ORCHESTRATORS_CONFIG='[
    {"url": "http://orchestrator-1:8080"},
    {"url": "http://orchestrator-2:8080"}
]'

MULTI_ORCHESTRATOR_MODE=ROUND_ROBIN
```

## 2. Продвинутая аутентификация воркеров (`workers.toml`)

Вместо использования одного общего `WORKER_TOKEN` для всех воркеров, вы можете назначить каждому из них индивидуальный токен. Это более безопасно, так как позволяет точечно отзывать доступ.

**1. Создайте файл `workers.toml`** в корне проекта Оркестратора:
```toml
# workers.toml
[worker-video-1]
token = "unique-secret-token-for-video-1"

[worker-audio-5]
token = "another-secret-for-audio-5"
```

**2. Укажите путь к файлу** в конфигурации Оркестратора:
```dotenv
# В .env файле Оркестратора
WORKERS_CONFIG_PATH="workers.toml"
```

**3. Настройте воркер** на использование своего ID и индивидуального токена:
```dotenv
# В .env файле Воркера
WORKER_ID="worker-video-1"
AVTOMATIKA_WORKER_TOKEN="unique-secret-token-for-video-1"
```
Оркестратор всегда будет в первую очередь пытаться аутентифицировать воркер по его индивидуальному токену.

## 3. Работа с большими файлами (S3 Payload Offloading)

SDK воркера "из коробки" поддерживает работу с большими файлами через S3-совместимое хранилище, что позволяет не перегружать Redis.

-   **Автоматическая загрузка:** Если в параметрах задачи приходит URI вида `s3://...`, SDK автоматически скачивает файл и подменяет URI на локальный путь перед вызовом вашего обработчика.
-   **Автоматическая выгрузка:** Если ваш обработчик возвращает локальный путь к файлу, SDK автоматически выгружает его в S3 и заменяет путь на `s3://` URI в итоговом результате.

Для включения этой функции достаточно настроить переменные окружения в воркере:
```dotenv
S3_ENDPOINT_URL=http://localhost:9000
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin
S3_BUCKET=worker-results
WORKER_PAYLOAD_DIR=/tmp/payloads # Директория, откуда разрешена выгрузка
```

## 4. Советы по отладке

### Проверка статуса и истории задачи

Используйте `curl` для запроса состояния и истории выполнения задачи. Это поможет понять, на каком шаге находится процесс и какие данные он содержит.

```bash
# Укажите ваш токен клиента
TOKEN="your-secret-orchestrator-token"

# Получить текущее состояние задачи
curl -H "X-Client-Token: $TOKEN" http://localhost:8080/api/v1/jobs/{job_id}

# Получить полную историю событий задачи (очень полезно для отладки)
curl -H "X-Client-Token: $TOKEN" http://localhost:8080/api/v1/jobs/{job_id}/history
```

### Визуализация логики блупринта

Чтобы понять сложную логику пайплайна, вы можете получить его граф в формате DOT и визуализировать его.

**1. Получите DOT-представление графа:**
```bash
curl -H "X-Client-Token: $TOKEN" http://localhost:8080/api/v1/blueprints/{blueprint_name}/graph
```

**2. Визуализируйте результат:**
Скопируйте полученный текстовый вывод и вставьте его в онлайн-визуализатор, например, [Graphviz Online](https://dreampuf.github.io/GraphvizOnline/). Вы сразу увидите диаграмму состояний и переходов вашего блупринта.
