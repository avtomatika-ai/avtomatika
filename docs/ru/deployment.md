[EN](https://github.com/avtomatika-ai/avtomatika/blob/main/docs/deployment.md) | [ES](https://github.com/avtomatika-ai/avtomatika/blob/main/docs/es/deployment.md) | **RU**

# Развертывание и Тестирование

Этот документ содержит рекомендации по запуску системы в производственной среде, а также инструкции для локальной разработки и тестирования.

## Развертывание в Production

Встроенный веб-сервер `aiohttp` отлично подходит для разработки, но для производственной среды требуется более надежное решение. Рекомендуется использовать production-ready ASGI-сервер.

### Пример 1: Gunicorn (Рекомендуемый, проверенный временем)

Gunicorn — это зрелый и широко используемый сервер с мощными возможностями по управлению процессами. Для запуска `aiohttp`-приложения с ним используется специальный `worker-class`.

```bash
# Вам понадобится создать файл app.py, который инициализирует и возвращает
# объект приложения из движка (engine.app)
gunicorn app:app --bind 0.0.0.0:8080 --worker-class aiohttp.GunicornWebWorker
```

### Пример 2: Uvicorn (Современный ASGI-сервер)

Uvicorn — это современный, высокопроизводительный ASGI-сервер, построенный на базе `uvloop`. Он также является отличным выбором для запуска `aiohttp`-приложений.

```bash
# Установите uvicorn: pip install uvicorn
uvicorn app:app --host 0.0.0.0 --port 8080
```

**Выбор сервера зависит от ваших предпочтений и требований к инфраструктуре.** Gunicorn предоставляет более продвинутое управление процессами "из коробки", в то время как Uvicorn часто показывает более высокую производительность в бенчмарках для чисто асинхронных приложений. Оба варианта являются надежными для производственной эксплуатации.

### Безопасность

**Критически важно:** Не запускайте систему в production со стандартными токенами. Установите уникальные и надежные токены для следующих переменных окружения:
- `CLIENT_TOKEN` (используется для проверки заголовка `X-Client-Token` от клиентов)
- `GLOBAL_WORKER_TOKEN` (используется для проверки заголовка `X-Worker-Token` от воркеров, если не задан индивидуальный токен)

Для инсталляций с поддержкой S3 убедитесь, что `S3_ACCESS_KEY` и `S3_SECRET_KEY` хранятся безопасно (например, через Docker Secrets или Vault).

Для повышения безопасности используйте индивидуальные токены для каждого воркера с помощью файла `workers.toml`.

## Локальная разработка и Тестирование

### Запуск всей системы (через Docker Compose)

Самый простой способ запустить все компоненты (Оркестратор, UI, Redis, Воркер) — использовать Docker Compose.

```bash
docker-compose up --build
```

-   **API Оркестратора** будет доступен по адресу `http://localhost:8080`.
-   **Пульт Управления (UI)** (если он есть в `docker-compose.yml`) будет доступен по адресу `http://localhost:8082`.

### Запуск тестов

В проекте несколько наборов тестов. **Крайне важно** запускать их после внесения изменений.

**1. Настройка окружения для тестов:**
Установите все необходимые зависимости, включая тестовые.
```bash
pip install -e ".[all,test]"
```

**2. Тесты ядра Оркестратора:**
```bash
pytest avtomatika/tests/
```

**3. Тесты SDK Воркера:**
```bash
pytest avtomatika-worker/tests/
```

**4. E2E-тесты (если применимо):**
Если в проекте есть end-to-end тесты, использующие Playwright, их запуск может потребовать предварительной установки браузеров.

```bash
# Установка браузеров для Playwright (если не установлены)
playwright install

# Запуск E2E-тестов (требуют запущенной системы через docker-compose up)
pytest tests/e2e/
```
